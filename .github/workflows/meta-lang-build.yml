name: "CPP Meta-Lang — 3OS Build + ProofLedger + Clean Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: cpptemplatelang-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # Setup Python (for SHA + tooling, 3OS 동일 동작)
      # ---------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # ---------------------------
      # DEBUG — src/ 검사 (3OS 공통, Python로 안전하게)
      # ---------------------------
      - name: DEBUG — List src/ and show meta_lang.cpp head
        run: |
          python - << 'PY'
          import os, glob, itertools
          print("=== LISTING src/ ===")
          if os.path.isdir("src"):
              for p in sorted(glob.glob("src/**/*", recursive=True)):
                  print(p)
          else:
              print("src NOT FOUND")
          print("=====================")
          print("=== HEAD OF src/meta_lang.cpp ===")
          try:
              with open("src/meta_lang.cpp", "r", encoding="utf-8", errors="ignore") as f:
                  for i, line in zip(range(50), f):
                      print(line.rstrip("\n"))
          except FileNotFoundError:
              print("meta_lang.cpp NOT FOUND")
          print("=================================")
          PY

      # ---------------------------
      # Compile (실패해도 계속)
      # - Linux/macOS: g++/clang++ 어느쪽이든 보통 존재
      # - Windows: 미존재 가능 → 실패해도 진행
      # ---------------------------
      - name: Compile Meta-Lang
        shell: bash
        run: |
          set -e
          mkdir -p dist
          echo "[Build] Compiling src/meta_lang.cpp ..."
          ( g++ -std=c++20 src/meta_lang.cpp -o dist/meta_lang 2>/dev/null \
            || clang++ -std=c++20 src/meta_lang.cpp -o dist/meta_lang 2>/dev/null ) \
          || { echo "Compile-time language: runtime executable not required. Skipping compiler output."; }

      # ---------------------------
      # ProofLedger (모든 *.cpp/*.hpp/*.h + 산출물 SHA256)
      # ---------------------------
      - name: Generate ProofLedger
        run: |
          python - << 'PY'
          import os, glob, hashlib, datetime
          repo   = os.environ.get("GITHUB_REPOSITORY","")
          commit = os.environ.get("GITHUB_SHA","")
          ref    = os.environ.get("GITHUB_REF","")
          actor  = os.environ.get("GITHUB_ACTOR","")
          run_id = os.environ.get("GITHUB_RUN_ID","")
          run_no = os.environ.get("GITHUB_RUN_NUMBER","")
          osname = os.environ.get("ImageOS","") or os.environ.get("RUNNER_OS","")
          ts     = datetime.datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")

          ledger_name = f"proofledger-{osname}.txt" if osname else "proofledger.txt"

          def sha256_of(path):
              h = hashlib.sha256()
              with open(path, "rb") as f:
                  for chunk in iter(lambda: f.read(65536), b""):
                      h.update(chunk)
              return h.hexdigest()

          lines = []
          lines.append(f"Repository: {repo}")
          lines.append(f"Commit: {commit}")
          lines.append(f"Ref: {ref}")
          lines.append(f"Actor: {actor}")
          lines.append(f"Run: {run_id} (#{run_no})")
          lines.append(f"OS: {osname}")
          lines.append(f"Build Time (UTC): {ts}")
          lines.append("")

          # 소스 SHA
          patterns = ["src/**/*.cpp", "src/**/*.hpp", "src/**/*.h", "src/*.cpp", "src/*.hpp", "src/*.h"]
          paths = sorted({p for pat in patterns for p in glob.glob(pat, recursive=True) if os.path.isfile(p)})
          if paths:
              lines.append("== SHA256 of source files ==")
              for p in paths:
                  try:
                      lines.append(f"{sha256_of(p)}  {p}")
                  except Exception as e:
                      lines.append(f"[ERROR] {p}: {e}")
              lines.append("")
          else:
              lines.append("No C++ sources found in src/")
              lines.append("")

          # 산출물 SHA
          bins = []
          if os.path.isdir("dist"):
              for p in glob.glob("dist/**", recursive=True):
                  if os.path.isfile(p):
                      bins.append(p)
          if bins:
              lines.append("== SHA256 of build outputs ==")
              for p in sorted(bins):
                  try:
                      lines.append(f"{sha256_of(p)}  {p}")
                  except Exception as e:
                      lines.append(f"[ERROR] {p}: {e}")
              lines.append("")

          with open(ledger_name, "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          print(f"[OK] Wrote {ledger_name}")
          PY

      # ---------------------------
      # Upload OS-specific artifact
      # ---------------------------
      - name: Upload Build & ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: meta-lang-${{ matrix.os }}
          path: |
            dist/**
            proofledger-*.txt
          if-no-files-found: warn
          retention-days: 7

  # ---------------------------
  # RELEASE JOB
  # ---------------------------
  release:
    name: "Create Auto Release"
    runs-on: ubuntu-latest
    needs: build-3os
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip Artifacts
        run: |
          zip -r meta-lang-artifacts.zip artifacts

      - name: Generate ZIP checksum
        run: |
          python - << 'PY'
          import hashlib
          p="meta-lang-artifacts.zip"
          h=hashlib.sha256()
          with open(p,"rb") as f:
              for c in iter(lambda:f.read(65536), b""):
                  h.update(c)
          open("meta-lang-artifacts.zip.sha256","w").write(f"{h.hexdigest()}  {p}\n")
          print("ZIP SHA256:", h.hexdigest())
          PY

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v1.${{ github.run_number }}"
          name: "CPP Meta-Lang — Build #${{ github.run_number }}"
          draft: false
          prerelease: false
          files: |
            meta-lang-artifacts.zip
            meta-lang-artifacts.zip.sha256
          generate_release_notes: true
